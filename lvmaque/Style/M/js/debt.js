itz.debt={},itz.debt.init=function(debtData){var util=itz.util;this.tabBind(),util.ajaxPager({pager:debtData.pager1,ajaxHostUrl:debtData.ajaxHostUrl1,loadImgPath:debtData.loadImgPath,container:"pagerContainer1",pagination:"pagination1"}),util.ajaxPager({pager:debtData.pager2,ajaxHostUrl:debtData.ajaxHostUrl2,loadImgPath:debtData.loadImgPath,container:"pagerContainer2",pagination:"pagination2"}),util.ajaxPager({pager:debtData.pager3,ajaxHostUrl:debtData.ajaxHostUrl3,loadImgPath:debtData.loadImgPath,container:"pagerContainer3",pagination:"pagination3"}),util.ajaxPager({pager:debtData.pager4,ajaxHostUrl:debtData.ajaxHostUrl4,loadImgPath:debtData.loadImgPath,container:"pagerContainer4",pagination:"pagination4"}),this.transferBtnBind(debtData),this.transferBtn2Bind(debtData),this.cancelTransferBtnBind(debtData),$("#pagerContainer3 .icon-xiala").poshytip({alignX:"right",alignY:"bottom",showTimeout:100,liveEvents:!0,content:function(updateCallback){var $this=$(this),id=$this.attr("_debtId");return $.ajax({url:debtData.tipAjaxUrl+"?debt_id="+id,dataType:"html",success:function(data){updateCallback(data)}}),"拼命加载中..."}}),$("#pagerContainer2 .icon-xiala").poshytip({alignX:"right",alignY:"bottom",showTimeout:100,liveEvents:!0,content:function(updateCallback){var $this=$(this),id=$this.attr("_debtId");return $.ajax({url:debtData.tipAjaxUrl+"?debt_id="+id,dataType:"html",success:function(data){updateCallback(data)}}),"拼命加载中..."}}),$("body").delegate(".closeBtn","click",function(){var id=$(this).parents(".ui-dialog-content").attr("id");$("#"+id).dialog("close")}),$(".icon-detail_show").itzTip({delegate:"body",position:"left:-170px;*left:-171px;top:28px;*top:12px",content:function(updateCallback){var $this=$(this),cid=$this.attr("_cid");return $.ajax({url:debtData.collectionUrl+"?tender_id="+cid,dataType:"html",success:function(data){updateCallback(data)}}),'<div class="interest-plan" style="text-align:center">拼命加载中...</div>'}}),$("#pagerContainer4 .icon-xiala").poshytip({alignY:"bottom",showTimeout:100,liveEvents:!0,content:function(updateCallback){var $this=$(this),id=$this.attr("_id"),cid=$this.attr("_cid"),debt_tender_id=$this.attr("_dtid"),url=debtData.tip4AjaxUrl+"?id="+id+"&type=borrow_detail_tpl6&cid="+cid+"&debt_tender_id="+debt_tender_id;return $.ajax({url:url,dataType:"html",success:function(data){updateCallback(data)}}),"拼命加载中..."}})},itz.debt.tabBind=function(){$("#tabs a").click(function(){var $t=$(this);if(!$t.hasClass("selected")){var $curNode=$t.parents("ul").find("a.selected");$curNode.removeClass("selected"),$("#"+$curNode.attr("_conId")).hide(),$t.addClass("selected"),$("#"+$t.attr("_conId")).show()}})},itz.debt.transferBtnBind=function(debtData){$("#pagerContainer1").delegate(".transferBtn","click",function(){var transferVal,$t=$(this),dataJson=$.parseJSON($t.attr("_dotdata")),util=itz.util,max=Math.floor(dataJson.max),min=dataJson.min;dataJson.status=1,util.promptA("debtPrompt","debtTmpl",dataJson,{width:610});var $transfer=$("#transferMoney"),$feeCon=$("#debtPrompt .feeCon");$transfer.val(min).css("padding-left","5px"),$feeCon.text(util.getFee(min,dataJson.con_debt_fee)),$transfer[0].setSelectionRange&&$transfer[0].setSelectionRange(10,10);var slider=$("#sliderBarH1").slider({max:max,min:min,range:"min",step:parseInt(dataJson.borrowInfo.invest_step),slide:function(event,ui){$transfer.val(ui.value),$feeCon.text(util.getFee(ui.value,dataJson.con_debt_fee))}});$transfer.keyup(function(){var val=$transfer.val();return""===val||isNaN(val)?(slider.slider("value",0),$feeCon.text("0"),void 0):(slider.slider("value",val),$feeCon.text(util.getFee(val,dataJson.con_debt_fee)),void 0)}),$("#debtPrompt #next1").click(function(){var $that1=$(this),_step=dataJson.borrowInfo.invest_step;if(transferVal=$transfer.val(),!transferVal)return $("#stepError1").text("请填写转让金额！").show(),void 0;if(/^\d*\.\d+$/.test(transferVal))return $("#stepError1").text("金额为整数！").show(),void 0;if(isNaN(transferVal))return $("#stepError1").text("金额应为数字！").show(),void 0;if(transferVal=parseInt(transferVal),transferVal>max)return $("#stepError1").text("最大转让份额为"+max+"元").show(),void 0;if(min>transferVal)return $("#stepError1").text("最小转让份额为"+min+"元").show(),void 0;if(transferVal%_step>0)return $("#stepError1").text("金额必须为"+_step+"的整数倍").show(),void 0;$that1.attr("disabled",!0).val("请稍后...");var feeVal=$feeCon.text();$.ajax({type:"get",dataType:"JSON",url:debtData.debtReqAjax,data:"id="+dataJson.tender_id,error:function(){$("#stepError1").text("出错啦，请重试").show(),$that1.removeAttr("disabled").val("下一步")},success:function(data){function setDebtApr(curNum){var apr=itz.debt.getDebtApr({x_interest:d.x_interest,curScale:curScale,curNum:curNum,transferTotal:transferVal,con_debt_fee:dataJson.con_debt_fee,x_days:d.x_days,a:d.a,y_interest:d.y_interest,y_a_days:d.y_a_days,apr:borrowInfo.apr}),$debtPrompt=$("#debtPrompt");apr.sellerVal=(transferVal-feeVal-curNum).toFixed(2),apr.seller=(100*apr.seller).toFixed(2),apr.buyer=(100*apr.buyer).toFixed(2),apr.seller=0==Math.abs(apr.seller)?"0.00":apr.seller,apr.buyer=0==Math.abs(apr.buyer)?"0.00":apr.buyer,$debtPrompt.find(".green654").text(apr.seller+"%"),$debtPrompt.find(".gray333").text(apr.buyer+"%"),$debtPrompt.find(".sellerVal").text(apr.sellerVal);var $aprTip=$debtPrompt.find("#aprTip");$transferMoneyError2.hide(),apr.buyer<=0?($aprTip.text("不允许设置折让金使认购方收益率为0%").css("color","red"),$("#debtPrompt #next2").attr("disabled",!0).addClass("btn-style-4")):apr.buyer<8?($aprTip.text("您设置的折让金太低，导致认购方的收益率不足8%，这样成交的概率很低").removeAttr("style"),$("#debtPrompt #next2").removeAttr("disabled").removeClass("btn-style-4")):apr.buyer>=8&&apr.buyer<=15?($aprTip.text("您设置的折让金比较合理，提高折让金会增加转让成功的概率").removeAttr("style"),$("#debtPrompt #next2").removeAttr("disabled").removeClass("btn-style-4")):apr.buyer>15&&($aprTip.text("您设置的折让金转让成功概率很高").removeAttr("style"),$("#debtPrompt #next2").removeAttr("disabled").removeClass("btn-style-4"))}if(0==data.code){dataJson.status=2,util.promptA("debtPrompt","debtTmpl",dataJson,{width:610});var $transferMoney2=$("#transferMoney2"),$transferMoneyError2=$("#transferMoneyError2"),d=data.data,borrowInfo=dataJson.borrowInfo,curScale=transferVal/dataJson.max,discountMax=Number((d.x_interest*curScale).toFixed(2)),discountMin=-(d.y_interest*curScale).toFixed(2),defaultVal=borrowInfo.apr/100/365*d.a*transferVal;defaultVal=defaultVal?-defaultVal.toFixed(2):0,$transferMoney2.val(defaultVal),setDebtApr(defaultVal),$transferMoney2.keyup(function(){var $t=$(this),valStr=$t.val(),val=Number(valStr);if(""===valStr)return $transferMoneyError2.text("请填写折让金").show(),void 0;if(isNaN(valStr))return $transferMoneyError2.text("必须是数字,且最多2位小数").show(),void 0;if(Math.floor(100*val)<100*val){var temp=val.toFixed(2);$t.val(temp),val=temp}return val>discountMax?($transferMoneyError2.text("让利应小于已收利息").show(),void 0):discountMin>val?($transferMoneyError2.text("得利不能大于买家未来的利息").show(),void 0):($transferMoneyError2.is(":hidden")||$transferMoneyError2.hide(),val&&slider2.slider("value",val),setDebtApr(val),void 0)}).blur(function(){var splitArray,$t=$(this),valStr=$t.val(),p=valStr.indexOf(".");if(-1!=p&&Number(valStr))if(splitArray=valStr.split("."),p===valStr.length-1)$t.val(valStr.substr(0,p));else if(splitArray[1].length>=2){var temp=Number(valStr).toFixed(2);if(temp){if(Math.floor(temp)==temp)return $t.val(temp.substr(0,p)),void 0;$t.val(temp)}}});var slider2=$("#sliderBarH2").slider({max:discountMax,min:discountMin,range:"min",step:.01,value:defaultVal,slide:function(event,ui){$transferMoney2.val(ui.value),setDebtApr(ui.value)}});$("#debtPrompt #next2").click(function(){if($transferMoneyError2.is(":hidden")){var discount=$transferMoney2.val();dataJson.transferVal=transferVal,dataJson.discount=discount,dataJson.defaultVal=defaultVal,dataJson.sellerVal=(transferVal-feeVal-discount).toFixed(2),dataJson.feeVal=feeVal,dataJson.expectedRate=$("#debtPrompt .green654").text(),dataJson.status=3,util.promptA("debtPrompt","debtTmpl",dataJson,{width:610});var $payPwd=$("#payPwd"),$payError=$("#payError"),errorStatus=0;$payPwd.keyup(function(){var val=$payPwd.val();return errorStatus=1,val?val.length<6||val.length>16?($payError.text("支付密码应为6-16位").show(),void 0):($payError.is(":hidden")||$payError.hide(),errorStatus=0,void 0):($payError.text("请填写支付密码").show(),void 0)}),$("#debtPrompt #next3").click(function(){var $that3=$(this),$stepError3=$("#stepError3");return $payPwd.val()?(errorStatus||($stepError3.hide(),$that3.attr("disabled",!0).val("提交中..."),$.ajax({type:"post",dataType:"jsonp",jsonp:"jsoncallback",url:debtData.baseUrl+"/dinvest/ajax/newdebt",data:"tender_id="+dataJson.tender_id+"&money="+transferVal+"&discount_money="+discount+"&paypassword="+encodeURIComponent($payPwd.val())+"&is_ajax=1",error:function(){$stepError3.text("出错啦，请重试").show(),$that3.removeAttr("disabled").val("确认提交")},success:function(data){0==data.code?($("#debtPrompt").dialog("close"),util.promptA("status_prompt","promptTmpl",["转债提示","债权转让发布成功","启动债权转让等待投资人认购<br/>",1],{close:function(){location.reload()}})):($stepError3.text(data.info).show(),$that3.removeAttr("disabled").val("确认提交"))}})),void 0):($payError.text("请填写支付密码").show(),void 0)})}})}else $("#stepError1").text("出错啦，请重试").show(),$that1.removeAttr("disabled").val("下一步")}})})})},itz.debt.transferBtn2Bind=function(debtData){$("#pagerContainer1").delegate(".transferBtn2","click",function(){var transferVal,$t=$(this),dataJson=$.parseJSON($t.attr("_dotdata")),util=itz.util,max=dataJson.max.toFixed(2),min=dataJson.min;dataJson.status=1,util.promptA("debtPrompt","debtTmpl",dataJson,{width:610});var $transfer=$("#transferMoney"),$feeCon=$("#debtPrompt .feeCon");$transfer.val(min).css("padding-left","5px"),$feeCon.text(util.getFee(min,dataJson.con_debt_fee)),$transfer[0].setSelectionRange&&$transfer[0].setSelectionRange(10,10);var slider=$("#sliderBarH1").slider({max:max,min:min,range:"min",step:parseInt(dataJson.borrowInfo.invest_step),slide:function(event,ui){ui.value>max&&(ui.value=max),$transfer.val(ui.value),$feeCon.text(util.getFee(ui.value,dataJson.con_debt_fee))}});$transfer.keyup(function(){var val=$transfer.val();return""===val||isNaN(val)?(slider.slider("value",0),$feeCon.text("0"),void 0):(slider.slider("value",Number(val)),$feeCon.text(util.getFee(val,dataJson.con_debt_fee)),void 0)}),$("#debtPrompt #next1").click(function(){var $that1=$(this),_step=dataJson.borrowInfo.invest_step;if(transferVal=$transfer.val(),!transferVal)return $("#stepError1").text("请填写转让金额！").show(),void 0;if(isNaN(transferVal))return $("#stepError1").text("金额应为数字！").show(),void 0;if(transferVal=Number(transferVal),/^\d*\.\d+$/.test(transferVal)&&transferVal!=max)return $("#stepError1").text("金额为整数！").show(),void 0;if(transferVal>max)return $("#stepError1").text("最大转让份额为"+max+"元").show(),void 0;if(min>transferVal)return $("#stepError1").text("最小转让份额为"+min+"元").show(),void 0;if(transferVal%_step>0&&transferVal!=max)return $("#stepError1").text("金额必须为"+_step+"的整数倍").show(),void 0;if(100>max-transferVal&&max-transferVal>0)return $("#stepError1").text("剩余本金不能少于"+_step+"元，请重新设置转让金额").show(),void 0;$that1.attr("disabled",!0).val("请稍后...");var feeVal=$feeCon.text();$.ajax({type:"get",dataType:"JSON",url:debtData.debtReqAjax,data:"id="+dataJson.tender_id,error:function(){$("#stepError1").text("出错啦，请重试").show(),$that1.removeAttr("disabled").val("下一步")},success:function(data){function setDebtApr(curNum){var apr=itz.debt.getDebtAvgApr({transferVal:transferVal,discount:curNum,transferMax:dataJson.max,everyMonthRepayAccount:d.every_month_repay_account,nextPayDays:d.that_term_days-d.that_term_past_days,remainRepayedTermNum:d.remain_repayed_term_num,thatTermPastDays:d.that_term_past_days,repayedTermNum:d.repayed_term_num,debtFee:dataJson.con_debt_fee,sellerNscale:d.dNscale,dsx:d.x}),$debtPrompt=$("#debtPrompt");apr.sellerVal=(transferVal-feeVal-curNum).toFixed(2),apr.seller=(apr.seller/100).toFixed(2),apr.buyer=(apr.buyer/100).toFixed(2),apr.seller=0==Math.abs(apr.seller)?"0.00":apr.seller,apr.buyer=0==Math.abs(apr.buyer)?"0.00":apr.buyer,$debtPrompt.find(".green654").text(apr.seller+"%"),$debtPrompt.find(".gray333").text(apr.buyer+"%"),$debtPrompt.find(".sellerVal").text(apr.sellerVal);var $aprTip=$debtPrompt.find("#aprTip");$transferMoneyError2.hide(),apr.buyer<=0?($aprTip.text("不允许设置折让金使认购方收益率为0%").css("color","red"),$("#debtPrompt #next2").attr("disabled",!0).addClass("btn-style-4")):apr.buyer<8?($aprTip.text("您设置的折让金太低，导致认购方的收益率不足8%，这样成交的概率很低").removeAttr("style"),$("#debtPrompt #next2").removeAttr("disabled").removeClass("btn-style-4")):apr.buyer>=8&&apr.buyer<=15?($aprTip.text("您设置的折让金比较合理，提高折让金会增加转让成功的概率").removeAttr("style"),$("#debtPrompt #next2").removeAttr("disabled").removeClass("btn-style-4")):apr.buyer>15&&($aprTip.text("您设置的折让金转让成功概率很高").removeAttr("style"),$("#debtPrompt #next2").removeAttr("disabled").removeClass("btn-style-4"))}if(0==data.code){dataJson.status=2,util.promptA("debtPrompt","debtTmpl",dataJson,{width:610});var $transferMoney2=$("#transferMoney2"),$transferMoneyError2=$("#transferMoneyError2"),d=data.data,curScale=(dataJson.borrowInfo,transferVal/dataJson.max),discountMax=Number((d.deng_repayed_interest*curScale).toFixed(2)),discountMin=-(d.y_interest*curScale).toFixed(2),defaultVal=d.that_term_interst*(d.that_term_past_days/d.that_term_days)*curScale;defaultVal=defaultVal?-defaultVal.toFixed(2):0,$transferMoney2.val(defaultVal),setDebtApr(defaultVal);var clearDebtApr;$transferMoney2.keyup(function(){var $t=$(this),valStr=$t.val(),val=Number(valStr);if(clearDebtApr&&clearTimeout(clearDebtApr),""===valStr)return $transferMoneyError2.text("请填写折让金").show(),void 0;if(isNaN(valStr))return $transferMoneyError2.text("必须是数字,且最多2位小数").show(),void 0;if(Math.floor(100*val)<100*val){var temp=val.toFixed(2);$t.val(temp),val=temp}return val>discountMax?($transferMoneyError2.text("让利应小于已收利息").show(),void 0):discountMin>val?($transferMoneyError2.text("得利不能大于买家未来的利息").show(),void 0):($transferMoneyError2.is(":hidden")||$transferMoneyError2.hide(),val&&slider2.slider("value",val),clearDebtApr=setTimeout(function(){setDebtApr(val)},500),void 0)}).blur(function(){var splitArray,$t=$(this),valStr=$t.val(),p=valStr.indexOf(".");if(-1!=p&&Number(valStr))if(splitArray=valStr.split("."),p===valStr.length-1)$t.val(valStr.substr(0,p));else if(splitArray[1].length>=2){var temp=Number(valStr).toFixed(2);if(temp){if(Math.floor(temp)==temp)return $t.val(temp.substr(0,p)),void 0;$t.val(temp)}}});var slider2=$("#sliderBarH2").slider({max:discountMax,min:discountMin,range:"min",step:.01,value:defaultVal,slide:function(event,ui){$transferMoney2.val(ui.value),setDebtApr(ui.value)}});$("#debtPrompt #next2").click(function(){if($transferMoneyError2.is(":hidden")){var discount=$transferMoney2.val();dataJson.transferVal=transferVal,dataJson.discount=discount,dataJson.expectedRate=$("#debtPrompt .green654").text(),dataJson.defaultVal=defaultVal,dataJson.sellerVal=(transferVal-feeVal-discount).toFixed(2),dataJson.feeVal=feeVal,dataJson.status=3,util.promptA("debtPrompt","debtTmpl",dataJson,{width:610});var $payPwd=$("#payPwd"),$payError=$("#payError"),errorStatus=0;$payPwd.keyup(function(){var val=$payPwd.val();return errorStatus=1,val?val.length<6||val.length>16?($payError.text("支付密码应为6-16位").show(),void 0):($payError.is(":hidden")||$payError.hide(),errorStatus=0,void 0):($payError.text("请填写支付密码").show(),void 0)}),$("#debtPrompt #next3").click(function(){var $that3=$(this),$stepError3=$("#stepError3");return $payPwd.val()?(errorStatus||($stepError3.hide(),$that3.attr("disabled",!0).val("提交中..."),$.ajax({type:"post",dataType:"jsonp",jsonp:"jsoncallback",url:debtData.baseUrl+"/dinvest/ajax/newdebt",data:"tender_id="+dataJson.tender_id+"&money="+transferVal+"&discount_money="+discount+"&paypassword="+encodeURIComponent($payPwd.val())+"&is_ajax=1",error:function(){$stepError3.text("出错啦，请重试").show(),$that3.removeAttr("disabled").val("确认提交")},success:function(data){0==data.code?($("#debtPrompt").dialog("close"),util.promptA("status_prompt","promptTmpl",["转债提示","债权转让发布成功","启动债权转让等待投资人认购<br/>",1],{close:function(){location.reload()}})):($stepError3.text(data.info).show(),$that3.removeAttr("disabled").val("确认提交"))}})),void 0):($payError.text("请填写支付密码").show(),void 0)})}})}else $("#stepError1").text("出错啦，请重试").show(),$that1.removeAttr("disabled").val("下一步")}})})})},itz.debt.cancelTransferBtnBind=function(debtData){$("#pagerContainer2").delegate(".cancelTransferBtn","click",function(){var $t=$(this),dataJson=$.parseJSON($t.attr("_dotdata")),util=itz.util,feeVal=util.getFee(dataJson.money,dataJson.con_debt_fee);dataJson.feeVal=feeVal,dataJson.sellerVal=(dataJson.money-feeVal-dataJson.discount).toFixed(2),util.promptA("cancelDebtPrompt","cancelDebtTmpl",dataJson,{width:610});var $payPwdCancel=$("#payPwdCancel"),errorStatus=0,$payErrorCancel=$("#payErrorCancel");$payPwdCancel.keyup(function(){var val=$payPwdCancel.val();return errorStatus=1,val?val.length<6||val.length>16?($payErrorCancel.text("支付密码要在6-16位之间").show(),void 0):($payErrorCancel.is(":hidden")||$payErrorCancel.hide(),errorStatus=0,void 0):($payErrorCancel.text("请填写支付密码").show(),void 0)}),$("#cancelDebtPrompt #cancelBtn").click(function(){var $tBtn=$(this),$errorCancel=$("#errorCancel");return $payPwdCancel.val()?(errorStatus||($errorCancel.hide(),$tBtn.attr("disabled",!0).val("提交中..."),$.ajax({type:"post",dataType:"jsonp",jsonp:"jsoncallback",url:debtData.baseUrl+"/dinvest/ajax/canceldebt",data:"debt_id="+dataJson.debt_id+"&paypassword="+encodeURIComponent($payPwdCancel.val())+"&is_ajax=1",error:function(){$errorCancel.text("出错啦，请重试").show(),$tBtn.removeAttr("disabled").val("确认提交")},success:function(data){0==data.code?($("#cancelDebtPrompt").dialog("close"),util.promptA("status_prompt","promptTmpl",["转债提示","债权转让取消成功","",1],{close:function(){location.reload()}})):($errorCancel.text(data.info).show(),$tBtn.removeAttr("disabled").val("确认提交"))}})),void 0):($payErrorCancel.text("请填写支付密码").show(),void 0)})})},itz.debt.getDebtApr=function(option){return option.curNum=Number(option.curNum),{seller:(option.x_days*option.apr*option.transferTotal/36500-option.curNum-option.transferTotal*option.con_debt_fee)/option.transferTotal*(365/(option.x_days+option.a)),buyer:(option.y_interest*option.curScale+option.curNum)/(option.transferTotal-option.curNum)*(365/option.y_a_days)}},itz.debt.getDebtAvgApr=function(option){function earningHandle($dN,$result){for(var lastKey,lastVal,tempVal,len=$result.length,i=1;len>i;i++)tempVal=Math.abs($dN-$result[i]),(void 0===lastVal||lastVal>tempVal)&&(lastVal=tempVal,lastKey=i);return 12*lastKey}function buyerEarning($dN,$x,$u,$n){for(var dnTemp,denominator,iTemp,arr=[],i=1;1e3>i;i++){dnTemp=0,iTemp=i/1e4;for(var j=0;$n>=j;j++)denominator=Math.pow(1+iTemp,$u+j),dnTemp+=$x/denominator;arr[i]=dnTemp}return earningHandle($dN,arr)}function sellerEarning($dN,$x,$y,$u,$n){for(var dnTemp,denominator,iTemp,arr=[],i=1;1e3>i;i++){dnTemp=0,iTemp=i/1e4;for(var j=1;$n>=j;j++)denominator=Math.pow(1+iTemp,j),dnTemp+=$x/denominator;denominator=Math.pow(1+iTemp,$n+$u),dnTemp+=$y/denominator,arr[i]=dnTemp}return earningHandle($dN,arr)}return{seller:sellerEarning(option.transferVal*option.sellerNscale,option.transferVal*option.dsx,option.transferVal-option.discount-option.transferVal*option.debtFee,option.thatTermPastDays/30,option.repayedTermNum),buyer:buyerEarning(option.transferVal-option.discount,option.everyMonthRepayAccount*(option.transferVal/option.transferMax),option.nextPayDays/30,option.remainRepayedTermNum-1)}},$.fn.itzTip=function(options){function tip($this){this.$this=$this,this.init()}function handler(){var $this=$(this),content=($this.parent(),"[title]"==options.content?$this.attr("title"):options.content);if($this.attr("tipId")!==tip.currentTip){var $tips=$("."+options.className);$tips.length&&($tips.parent().css({"z-index":0}),$tips.remove()),tip.currentTip=$this.attr("tipId"),tip.obj=new tip($this),"function"==typeof content?tip.obj.update(content.call(this,function(c){var obj=tip.obj;obj.close(),obj.update(c)})):tip.obj.update(content)}}var defaultOptions,$t=this;defaultOptions={className:"itz-tip",delegate:!1,position:"left:0;top:0",content:"[title]"},options=$.extend(defaultOptions,options),options.delegate?$(options.delegate).delegate($t.selector,"click",handler):$t.click(handler),$t.each(function(index,ele){$(ele).attr("tipId",index)});var PROTOTYPE=tip.prototype;PROTOTYPE.init=function(){tip.obj=null},PROTOTYPE.update=function(data){var $this=this.$this;$this.parent().css({"z-index":100}).append($('<div class="poptip '+options.className+'" style="z-index:1000;'+options.position+'"><span class="poptip-arrow poptip-arrow-top"><em>◆</em><i>◆</i></span></div>').append(data))},PROTOTYPE.close=function(){var $this=this.$this;$this.parent().find("."+options.className).remove()},$(document).delegate("body","click",function(e){var $node=$(e.target);if(!$node.attr("tipId")||$node.attr("tipId")!==tip.currentTip){var $tips=$("."+options.className);$tips.parent().css({"z-index":0}),$tips.remove(),tip.currentTip=null}})};