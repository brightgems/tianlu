<include file="default:Public:_header_common" group="Home"/>
	<title>找回密码-验证身份 -- {$glo.web_name}</title>
<include file="default:Public:_header_main" group="Home"/>
<link rel="stylesheet" href="__ROOT__/Style/M/css/min.css">
<link rel="stylesheet" href="__ROOT__/Style/M/css/login_register.css">
</head>
<body>
<div class="register-page" style="padding-bottom: 0px;background: #F2F2F2;">

   <div class="login_register-con-inner clearfix" style="height:650px">
        <div class="title-style-1">
            <h2>找回密码</h2>
        </div>
        <div class="login_register-find_password">
            <ul class="login_register-step clearfix">
                <li>
                    <span class="login_register-step-line"></span>
                    <span class="login_register-step-num">1</span>
                    <p class="login_register-step-txt" style="left:-14px;">输入登录账号</p>
                </li>
                <li class="current">
                    <span class="login_register-step-line"></span>
                    <span class="login_register-step-num">2</span>
                    <p class="login_register-step-txt" style="left:-3px;">验证身份</p>
                </li>
                <li>
                    <span class="login_register-step-line"></span>
                    <span class="login_register-step-num">3</span>
                    <p class="login_register-step-txt" style="left:-3px;">重置密码</p>
                </li>
                <li class="login_register-step-end">
                    <span class="login_register-step-line"></span>
                    <span class="login_register-step-num">√</span>
                    <p class="login_register-step-txt" style="left:8px;">完成</p>
                </li>
            </ul>
            <form id="formStep2" action="" novalidate="novalidate">
                <ul class="register-con-form register-con-form-2 clearfix">
                    <li>
                        <label class="rcf-label">请选择找回方式</label>
                        <div class="rcf-txt-value rcf-txt-value-select-ie6">
                            <select id="switchSelect" class="select-style-3 valid" onChange="Cmd(this.value)">
                            	<if condition="$list.email_status eq 1 ">
                               <option value="1">邮箱</option>
                               </if>
                            	<if condition="$list.phone_status eq 1">
								<option value="0">手机</option>
								</if>
								<if condition="$list.safequestion_status eq 1">
								<option value="9">密保问题</option>
								</if>
                            </select>
                        </div>
                    </li>
            <div id="div0" style="display:none;">
            	<if condition="$is_manual eq 0 ">
                    <li class="phone-li">
                        <label class="rcf-label">手机号</label>
                        <div class="rcf-txt-value">{$list.user_phone|hidecard=###,2}</div>
                    </li>
                    <li class="rcf-phone_vlicode phone-li">
                        <label class="rcf-label">重新输入该手机号</label>
                        <input id="mobile" name="phone" type="text" class="input-text-style-3">   
                        <input id="sendSmsBtn" type="button" class="rcf-phone_send sms-channel" value="发送验证码" onClick="send_phone()">
                        <div class="rcf-alert">
                            <span class="rcf-alert-error"></span>
                        </div>
                    </li>

<li class="form-style-1-item yuyin-channel" style="display:none;">
											<label class="form-style-1-label rcf-label">&nbsp;</label><span class="form-style-1-other"><i class="js_info0">如果没有收到短信，您可</i><i class="js_info3"></i><i class="js_info1">请注意接听 010-5321233* 的来电，若没收到，您可</i><i class="yyct"></i><!--<i style='display:block'>点击</i>--><i class="js_info2">重新</i><i style="display:block">获取</i><input value="语音验证码" type="button" data-voice="true" class="voicech"></span>
										</li>

                    <li class="phone-li">
                        <label class="rcf-label">验证码</label>
                        <input name="sms_vcode" id="sms_vcode" type="text" maxlength="6" class="input-text-style-3" style="width:100px">
                        <div class="rcf-alert">
                            <span class="rcf-alert-error"></span>
                        </div>
                    </li>
                    <li>
                        <span id="stepError" class="rcf-alert-container" style="display:none"></span>
                        <label class="rcf-label">&nbsp;</label>
                        <input id="submitBtn" type="button" class="input-submit-style-3 input-submit-width-1" value="下一步" onClick="subform()">          
                    </li>
                 <else />
                 <div class="login_register-email-con" style="background: rgba(0, 0, 0, 0) url('__ROOT__/Style/M/images/phoneBg.jpg') no-repeat scroll 0 0;">
                <h2>{$glo.web_name}温馨提示：</h2>
                <p>
                    尊敬的<strong><a href="#">{$list.user_phone|hidecard=###,2}</a></strong>用户您好！
                    <br>            
                    目前短信接口已关闭，请选择其它方式或联系客服。
                </p>
                <span>请选择其它找回方式或联系客服<?php $dw_kefu=get_qq(2);echo($dw_kefu[0]["qq_num"]); ?>，给您带来的不便，敬请谅解。</span>
            </div>
                 </if>
            </div>
            <div id="div1" style="display:none">
                    <li class="email-li" >
                        <label class="rcf-label">邮箱地址</label>
                        <div class="rcf-txt-value">{$list.user_email|hidecard=###,6}</div>
                    </li>
                    <li class="email-li">
                        <label class="rcf-label">重新输入该邮箱</label>
                        <input name="email" id="email" type="text" class="input-text-style-3">
                        <div class="rcf-alert">
                            <span class="rcf-alert-error"></span>
                        </div>
                    </li>
                    <li>
                        <span id="stepError1" class="rcf-alert-container" style="display:none"></span>
                        <label class="rcf-label">&nbsp;</label>
                        <input id="submitButn" type="button" class="input-submit-style-3 input-submit-width-1" value="发送验证邮箱" onClick="sendemail()">          
                    </li>
             </div>
             <div id="div9" style="display:none;">
                    <li class="email-li" >
                        <label class="rcf-label">问题1</label>
                        <div class="rcf-txt-value">{$list.question1}</div>
                    </li>
                    <li class="email-li">
                        <label class="rcf-label">答案</label>
                        <input name="answer1" id="answer1" type="text" class="input-text-style-3">
                        <div class="rcf-alert">
                            <span class="rcf-alert-error"></span>
                        </div>
                    </li>
                    <li class="email-li" >
                        <label class="rcf-label">问题2</label>
                        <div class="rcf-txt-value">{$list.question2}</div>
                    </li>
                    <li class="email-li">
                        <label class="rcf-label">答案</label>
                        <input name="answer2" id="answer2" type="text" class="input-text-style-3">
                        <div class="rcf-alert">
                            <span class="rcf-alert-error"></span>
                        </div>
                    </li>
                    <li>
                        <span id="stepError2" class="rcf-alert-container" style="display:none"></span>
                        <label class="rcf-label">&nbsp;</label>
                        <input id="submitBtnans" type="button" class="input-submit-style-3 input-submit-width-1" value="下一步" onClick="next()">          
                    </li>
             </div>
                </ul>
            </form>
            <div id="emailSuccess" class="login_register-email-con" style="display:none;">
                <h2>您正在使用"邮箱验证身份"找回密码，请完成以下操作：</h2>
                <p>
                    邮件已发送到您的邮箱 <strong><a id="emailLink" target="_blank">{$list.user_email|hidecard=###,6}</a></strong>
                    <br>            
                    请按邮箱中的提示操作，完成身份验证。
                </p>
                <span>一直没有收到邮件？请先检查是否在垃圾邮件中。如果还未收到，点击<a href="">重新发送</a>验证邮件</span>
            </div>
            <p class="register-reward-info register-reward-info-1" style="display:none;"> <strong>邮箱验证成功，请继续操作</strong>
                <a href="">继续重置登录密码</a>
            </p>
        </div>
    </div>
    
</div>
<include file="Public:_footer" />   

<script>
var mbTest = /^(13|14|15|17|18)[0-9]{9}$/;
var timer = null;
var leftsecond = 60; //倒计时
var msg = "";
$(document).ready(function(){
	var a = $("#switchSelect").val();
	if( a == '1' ){
		$("#div1").removeAttr("style");
	}
	if( a == '0' ){
		$("#div0").removeAttr("style");
	}
	if( a == '9' ){
		$("#div9").removeAttr("style");
	}
})
function Cmd(obj){
	if(obj == '1'){
		$("#div1").show();
		$("#div0").hide();
		$("#div9").hide();
	}
	if(obj == '0'){
		$("#div0").show();
		$("#div1").hide();
		$("#div9").hide();
	}
	if(obj == '9'){
		$("#div9").show();
		$("#div1").hide();
		$("#div0").hide();
	}
}
    //手机验证
    function send_phone(){
    	var mobile = $("#mobile").val();
    	if (mobile == ''){
    		$('#stepError').html('<font style="color:red"> × 请填写手机号！</font>');
			$("#stepError").removeAttr("style");
			return;
    	}
    	if (mbTest.test(mobile)) {
    		$("#stepError").removeAttr("style");
    		$('#stepError').html("短信发送中...");
    		$.ajax({
    			url: "__URL__/getpwdsendphone/",
    			type: "post",
    			dataType: "json",
    			data: {"cellphone":mobile},
    			success: function(d) {
    				leftsecond = 60;
    				if (d.status == 1) {
    					msg = " √ 发送成功，如未收到";
    					clearInterval(timer);
    					timer = setInterval(setLeftTime, 1000, "1");
    					$("#mobile").attr("disabled",true);	//false	手机号禁止输入
    					$("#sendSmsBtn").removeAttr("onclick");	//发送时间内，不能再次发送
    				}else if(d.status == 2){
    					$("#stepError").html(' × 手机号不一致！');
    					return;
    				}else {
    					msg = " × 校验码发送失败,请重试";
    					$("#stepError").html(msg);
    					$("#mobile").attr("disabled",false);
    				}
    			}
    		});
    	}else {
    		$("#stepError").html(" × 手机号码有误！");
    		return;
    	}	
    }
    function setLeftTime() {
    	var second = Math.floor(leftsecond);
    	$("#stepError").eq(0).html(msg + second + "秒后可重发");
    	leftsecond--;
    	if (leftsecond < 1) {
    		$("#stepError").eq(0).html("现在可重新发送！");
    		clearInterval(timer);
    		$("#sendSmsBtn").attr("onclick","send_phone();");	//发送时间截止，添加发送事件
    		try {
    			$("#mobile").attr("disabled",false);	//恢复手机号输入
    		} catch (E) { }
    		return;
    	}
    }
    
  	// 下一步
    function subform(){
    	var Mobile = $("#mobile").val();	//手机号
    	var Vode = $("#sms_vcode").val();	//验证码 
    	if(Mobile=='' || Vode==''){
    		$('#stepError').html(' × 验证内容不能为空！');
			$("#stepError").removeAttr("style");
			return;
    	}
    	if (!mbTest.test(Mobile)) {
    		$('#stepError').html(' × 手机号码有误！');
    		return;
    	}
    	$.ajax({
            type: "post",
    		dataType: "json",
            url: "__URL__/cksubform/",
            data: {"Mobile": $("#mobile").val(), "Vcode": $("#sms_vcode").val() },
            success: function (d, s, r) {
              	if(d){
    				if(d.status==1){
    					window.location.href="/member/common/getpassword3";
    				}else if(d.status == 2){
    					$("#stepError").html(d.message);
    					$("#stepError").removeAttr("style");
    					return;
    				}else{
    					$('#stepError').html(d.message);
    					$("#stepError").removeAttr("style");
    					return;
    				}
    			}
    		}
        });
    }
    //密保下一步
    function next(){
    	var answer1 = $('#answer1').val();//答案1
    	var answer2 = $('#answer2').val();//答案2
    	if(answer1=='' || answer2==''){
    		$('#stepError2').html(' × 验证内容不能为空！');
			$("#stepError2").removeAttr("style");
			return;
    	}
    	$.ajax({
    		type:"post",
    		dataType:"json",
    		url:"__URL__/ck_question/",
    		data:{"answer1":answer1,"answer2":answer2},
    		success:function(d, s, r) {
    			if(d.status == 1) {
    				window.location.href="/member/common/getpassword3";
    			}else if(d.status == 2){
    	    		$('#stepError2').html(d.message);
    				$("#stepError2").removeAttr("style");
    				return;
    			}
    		}
    	});
    }
  	//发送验证邮箱
  	function sendemail(){
  		var ux = $("#email").val();
  		if(ux==''){
    		$('#stepError1').html(' × 邮箱地址不能为空！');
			$("#stepError1").removeAttr("style");
			return;
    	}
  		$.ajax({
  			url: "__APP__/member/common/dogetpass/",
  			data: {"u":ux},
  			cache: false,
  			type: "post",
  			dataType: "json",
  			success: function (d, s, r) {
  				if(d){
  					if(d.status==1){
  						$('#formStep2').css('display','none');
  						$('#emailSuccess').css('display','block');
  						//$("#emailSuccess").removeAttr("style");
  					}else{
  						$('#stepError1').html(' × 发送失败，请重试！');
  						$("#stepError1").removeAttr("style");
  						return;
  					}
  				}
  			}
  		});
  	}

</script>
</body></html>